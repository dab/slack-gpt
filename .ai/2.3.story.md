# Story 2.3: Implement Knowledge Base Service (PDF Processing)

## Story

**As a** Developer\
**I want** to implement a `KnowledgeBaseService` class\
**so that** the application can scan a directory for PDFs, extract their text content using `PyMuPDF`, and find text chunks relevant to a user's question to provide context for the OpenAI service.

## Status

Draft

## Context

This story creates the service responsible for interacting with the local PDF knowledge base, as defined in Arch Doc Section 3.2 (Component View) and Section 3.3 (Data View). It involves file system operations (scanning the configured `PDF_DATA_DIR`), PDF text extraction (`PyMuPDF`), and a basic text retrieval mechanism (simple keyword matching for MVP). Given PDF processing can be CPU-intensive, consider using `asyncio.to_thread` if initial tests show blocking. Unit tests are required (Arch Doc Section 8).

## Estimation

Story Points: 4

## Acceptance Criteria

1.  - [ ] `PyMuPDF~=1.24.x` added to `requirements.txt`.
2.  - [ ] `app/services/knowledge_base.py` created.
3.  - [ ] `KnowledgeBaseService` class implemented.
4.  - [ ] The `__init__` method takes the `pdf_data_dir` path (from config) and validates it. It might optionally pre-scan PDFs.
5.  - [ ] A method (e.g., `_scan_pdf_files`) exists to find all `.pdf` files within the configured directory.
6.  - [ ] A method (e.g., `_extract_text_from_pdf(pdf_path: str)`) exists that uses `fitz.open(pdf_path)` (from `PyMuPDF`) to open a PDF and iterates through pages (`page.get_text()`) to extract full text content. This method should handle potential `PyMuPDF` errors for corrupted files.
7.  - [ ] An asynchronous method `find_relevant_context(question: str)` is implemented:
    *   - [ ] It iterates through all found PDF files.
    *   - [ ] For each PDF, it extracts the text (potentially using the `_extract_text_from_pdf` method). Consider simple in-memory caching of extracted text per instance lifecycle.
    *   - [ ] It implements a basic search strategy on the extracted text (e.g., split text into chunks, check if keywords from the `question` appear in chunks, return a concatenation of relevant chunks up to a certain token limit).
    *   - [ ] It handles errors gracefully (e.g., logging issues with specific PDFs but continuing with others).
    *   - [ ] Potentially CPU-bound text extraction/searching logic within this async method should be wrapped in `asyncio.to_thread` to avoid blocking the event loop.
8.  - [ ] Basic logging is added for file scanning, text extraction, context finding, and errors.
9.  - [ ] Unit tests created in `tests/services/test_knowledge_base.py`.
10. - [ ] Unit tests mock filesystem operations (`os.listdir`, `os.path.join`, etc.) and `fitz.open` / `page.get_text` calls to test the service logic in isolation (finding files, text extraction calls, context retrieval logic, error handling). Use dummy PDF content/structure in mocks.
11. - [ ] Tests achieve >= 70% code coverage for `app/services/knowledge_base.py`.

## Subtasks

1.  - [ ] Add `PyMuPDF` package to `requirements.txt`. Run `pip install -r requirements.txt`.
2.  - [ ] Create `app/services/knowledge_base.py`.
3.  - [ ] Implement the `KnowledgeBaseService` class structure.
4.  - [ ] Implement `__init__` taking `pdf_data_dir` path from config.
5.  - [ ] Implement helper method `_scan_pdf_files`.
6.  - [ ] Implement helper method `_extract_text_from_pdf` using `PyMuPDF`. Include basic error handling.
7.  - [ ] Implement `async def find_relevant_context(question: str)` method.
    *   - [ ] Call scan/extraction methods.
    *   - [ ] Implement simple text chunking and keyword matching logic.
    *   - [ ] Consolidate relevant chunks.
    *   - [ ] Wrap blocking calls (`_extract_text_from_pdf`, search logic) in `asyncio.to_thread`.
    *   - [ ] Add error handling for file/PDF issues.
8.  - [ ] Add logging calls.
9.  - [ ] Create `tests/services/test_knowledge_base.py`.
10. - [ ] Write unit tests using `pytest`, `pytest-asyncio`, and mocking for filesystem and `PyMuPDF`.
    *   - [ ] Test finding PDF files.
    *   - [ ] Test calling text extraction mock.
    *   - [ ] Test basic context retrieval logic (mock extracted text).
    *   - [ ] Test error handling for file not found / bad PDF mock.
11. - [ ] Run `pytest tests/services/test_knowledge_base.py --cov=app/services/knowledge_base` to check coverage.
12. - [ ] Run linters/formatters.

## Testing Requirements:

*   Code coverage requirement >= 70% for `app/services/knowledge_base.py`.

## Story Wrap Up (To be filled in AFTER agent execution):

*   **Agent Model Used:** `<Agent Model Name/Version>`
*   **Agent Credit or Cost:** `<Cost/Credits Consumed>`
*   **Date/Time Completed:** `<Timestamp>`
*   **Commit Hash:** `<Git Commit Hash of resulting code>`
*   **Change Log**
    *   change X
    *   change Y
    ... 